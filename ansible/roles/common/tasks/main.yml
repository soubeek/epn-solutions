---
# Role: common
# Description: Installation des paquets de base et configuration système

- name: "Mettre à jour le cache APT"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: ['common', 'apt']

- name: "Mettre à jour tous les paquets"
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  tags: ['common', 'apt', 'upgrade']

- name: "Installer les paquets essentiels"
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - git
      - vim
      - htop
      - net-tools
      - dnsutils
      - tcpdump
      - nmap
      - wget
      - unzip
      - zip
      - python3
      - python3-pip
      - python3-venv
      - build-essential
      - ufw
      - fail2ban
      - rsync
      - cron
    state: present
  tags: ['common', 'packages']

- name: "Configurer la timezone"
  timezone:
    name: "{{ timezone }}"
  tags: ['common', 'timezone']

- name: "Configurer les locales"
  locale_gen:
    name: "{{ locale }}"
    state: present
  tags: ['common', 'locale']

- name: "Définir la locale par défaut"
  command: update-locale LANG={{ locale }} LANGUAGE={{ language }}
  changed_when: false
  tags: ['common', 'locale']

- name: "Créer l'utilisateur système pour l'application"
  user:
    name: "{{ app_user }}"
    group: "{{ app_group }}"
    create_home: yes
    shell: /bin/bash
    state: present
  tags: ['common', 'user']

- name: "Créer le répertoire du projet"
  file:
    path: "{{ project_path }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: ['common', 'directories']

- name: "Créer les répertoires de travail"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  loop:
    - "{{ tftp_root }}"
    - "{{ backup_dir }}"
    - /var/log/poste-public
    - /etc/poste-public
  tags: ['common', 'directories']

- name: "Configurer le hostname"
  hostname:
    name: "{{ server_hostname }}"
  tags: ['common', 'hostname']

- name: "Mettre à jour /etc/hosts"
  lineinfile:
    path: /etc/hosts
    line: "{{ server_ip }} {{ server_fqdn }} {{ server_hostname }}"
    state: present
  tags: ['common', 'hostname']

- name: "Configurer le firewall UFW - Autoriser SSH"
  ufw:
    rule: allow
    port: "{{ ssh_port }}"
    proto: tcp
  when: firewall_enabled
  tags: ['common', 'firewall']

- name: "Configurer le firewall UFW - Autoriser les ports nécessaires"
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ firewall_allow_ports }}"
  when: firewall_enabled
  tags: ['common', 'firewall']

- name: "Activer le firewall UFW"
  ufw:
    state: enabled
    policy: deny
    direction: incoming
  when: firewall_enabled
  tags: ['common', 'firewall']

- name: "Configurer Fail2ban"
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = {{ fail2ban_bantime }}
      findtime = 600
      maxretry = {{ fail2ban_max_retry }}

      [sshd]
      enabled = true
      port = {{ ssh_port }}
      logpath = /var/log/auth.log
  when: fail2ban_enabled
  notify: restart fail2ban
  tags: ['common', 'fail2ban']

- name: "Démarrer et activer Fail2ban"
  service:
    name: fail2ban
    state: started
    enabled: yes
  when: fail2ban_enabled
  tags: ['common', 'fail2ban']

- name: "Configurer la rotation des logs"
  copy:
    dest: /etc/logrotate.d/poste-public
    content: |
      /var/log/poste-public/*.log {
          daily
          rotate {{ log_retention_days }}
          compress
          delaycompress
          notifempty
          create 0640 {{ app_user }} {{ app_group }}
          sharedscripts
          postrotate
              systemctl reload rsyslog > /dev/null 2>&1 || true
          endscript
      }
  tags: ['common', 'logrotate']

- name: "Installer Python pip packages globaux"
  pip:
    name:
      - ansible
      - docker
      - docker-compose
    state: present
  tags: ['common', 'python']
