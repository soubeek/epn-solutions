# Docker Compose Override pour Production avec Certificats Auto-signés
# Ce fichier surcharge docker-compose.yml pour utiliser une CA locale
# au lieu de Let's Encrypt

services:
  # ==========================================
  # TRAEFIK - Configuration TLS Locale
  # ==========================================
  traefik:
    command:
      # API et Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=poste-public_frontend"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"

      # Désactiver ACME/Let's Encrypt (on utilise nos propres certificats)
      # Les certificats sont configurés via le fichier dynamic/tls.yml

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - traefik-logs:/var/log/traefik
      # Montage des certificats locaux
      - ./certs:/certs:ro

  # ==========================================
  # DJANGO - Variables additionnelles
  # ==========================================
  django:
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-poste_public}
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:?Erreur - SECRET_KEY non défini}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DEBUG=False
      - TZ=${TZ:-Indian/Reunion}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://localhost}
      # Sécurité HTTPS
      - SECURE_SSL_REDIRECT=True
      - SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
      - SESSION_COOKIE_SECURE=True
      - CSRF_COOKIE_SECURE=True

  # ==========================================
  # FRONTEND - Build avec bonnes URLs
  # ==========================================
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://${SERVER_FQDN:-localhost}/api
        - VITE_WS_URL=wss://${SERVER_FQDN:-localhost}/ws
        - VITE_APP_TITLE=EPN - Gestion des Postes Publics

  # ==========================================
  # PI-HOLE - Optionnel, peut être désactivé
  # ==========================================
  pihole:
    profiles:
      - dns-filtering
    # Ajouter le profil pour le rendre optionnel
    # Lancer avec: docker compose --profile dns-filtering up -d

  cloudflared:
    profiles:
      - dns-filtering
