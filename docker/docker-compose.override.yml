# Docker Compose Override pour Production avec Certificats Auto-signés
# Ce fichier surcharge docker-compose.yml pour utiliser une CA locale
# au lieu de Let's Encrypt

services:
  # ==========================================
  # TRAEFIK - Configuration TLS Locale
  # ==========================================
  traefik:
    command:
      # API et Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=${COMPOSE_PROJECT_NAME:-poste-public}_frontend"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"

      # Pas de ACME/Let's Encrypt - on utilise nos propres certificats
      # Les certificats sont configurés via le fichier dynamic/tls.yml

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - traefik-logs:/var/log/traefik
      # Montage des certificats locaux (CA + serveur)
      - ./certs:/certs:ro

  # ==========================================
  # DJANGO - Sécurité HTTPS additionnelle
  # ==========================================
  django:
    environment:
      # Variables de sécurité HTTPS (ajoutées au fichier principal)
      - SECURE_SSL_REDIRECT=True
      - SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
      - SESSION_COOKIE_SECURE=True
      - CSRF_COOKIE_SECURE=True

  # ==========================================
  # PI-HOLE & CLOUDFLARED - Optionnels
  # ==========================================
  pihole:
    profiles:
      - dns-filtering

  cloudflared:
    profiles:
      - dns-filtering

# Volume pour les logs Traefik (si non défini dans le fichier principal)
volumes:
  traefik-logs:
    driver: local
